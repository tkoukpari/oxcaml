# Minimal CI for forks: uses GitHub-hosted runners so jobs actually run.
# The main "build" workflow uses Warp runners that are only available in
# oxcaml/oxcaml, so fork runs stay pending. This workflow runs one build
# on ubuntu-latest when the repo is not the upstream.
name: build (fork)
on:
  push:
    branches: [main]
  pull_request:
jobs:
  build:
    if: github.repository != 'oxcaml/oxcaml'
    name: runtime5 (ubuntu-latest)
    runs-on: ubuntu-latest
    env:
      J: "4"
      run_testsuite: "true"
    steps:
      - name: Checkout the OxCaml repo
        uses: actions/checkout@master

      - name: Pretend we're running in a container (makes setup-ocaml go faster)
        run: sudo touch /.dockerenv

      - name: Set up Opam
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: oxcaml-ci-deps.5.2.0-with-ocaml.5.4.0
          opam-repositories: |
            local: file://${{ github.workspace }}/tools/ci/local-opam
            default: https://github.com/ocaml/opam-repository.git
          opam-disable-sandboxing: true
          opam-pin: false

      - name: Set up Opam environment
        run: |
          opam env --set-root --set-switch --shell=cmd | sed -n 's/^set //p' | tee -a "$GITHUB_ENV"

      - name: Configure OxCaml
        run: |
          autoconf
          ./configure --prefix=$GITHUB_WORKSPACE/_install --enable-runtime5

      - name: Build and test OxCaml
        run: |
          ulimit -c unlimited
          make ci
