(rule
 (alias   runtest)
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (deps t1.ml)
 (action (run %{bin:ocamlopt.opt} -no-probes-optimized %{deps} -warn-error "+190" -c)))

(rule
 (alias runtest)
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (deps region.ml)
 (action (run %{bin:ocamlopt.opt} -no-probes-optimized %{deps} -c)))

(executable
 (name t2)
 (modules t2))

(rule
 (alias   runtest)
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (deps t2.expected t2.output)
 (action (diff t2.expected t2.output)))

(rule
 (target t2.output)
 (deps t2.exe)
 (action (with-outputs-to %{target} (run %{deps}))))


(rule
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (target t3.output)
 (deps t3.ml)
 (action (with-outputs-to %{target}
         (with-accepted-exit-codes 2
         (run %{bin:ocamlopt.opt} -no-probes-optimized %{deps} -color never -error-style short -warn-error "+190" -c)))))

(rule
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (target t3.output.filtered)
 (deps t3.output)
 (action (with-outputs-to %{target}
         (pipe-outputs (run cat %{deps})
                  (run ./filter.sh)))))

(rule
 (alias   runtest)
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (deps t3.expected t3.output)
 (action (diff t3.expected t3.output.filtered)))

(rule
 (target test_ocamldep.output)
 (deps for_test_ocamldep1.ml for_test_ocamldep2.ml test_ocamldep.ml)
 (action (with-outputs-to %{target} (run %{bin:ocamlopt.opt} -depend %{deps}))))

(rule
 (alias   runtest)
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (deps test_ocamldep.expected test_ocamldep.output)
 (action (diff test_ocamldep.expected test_ocamldep.output)))

(rule
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (target f1.exe)
 (deps f1.ml)
 (action (with-accepted-exit-codes 0
         (run %{bin:ocamlopt.opt} -no-probes-optimized -O3 %{deps} -o f1.exe))))

(rule
 (target f1.output)
 (deps f1.exe)
 (action (with-outputs-to %{target}
         (with-accepted-exit-codes 2
         (with-outputs-to %{target} (run %{deps}))))))

(rule
 (alias   runtest)
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (deps f1.expected f1.output)
 (action (diff f1.expected f1.output)))

(rule
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (target f2.exe)
 (deps f2.ml)
 (action (with-accepted-exit-codes 0
         (run %{bin:ocamlopt.opt} -no-probes-optimized -O3 %{deps} -o f2.exe))))

(rule
 (target f2.output)
 (deps f2.exe)
 (action (with-outputs-to %{target}
         (with-accepted-exit-codes 2
         (with-outputs-to %{target} (run %{deps}))))))


(rule
 (alias   runtest)
 (enabled_if
  (and (= %{context_name} "main")
       (= %{system} "linux")))
 (deps f2.expected f2.output)
 (action (diff f2.expected f2.output)))
